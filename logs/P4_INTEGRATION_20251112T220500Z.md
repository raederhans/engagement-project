# Phase 4 — Hover-card CTA UI + session throttling (2025-11-12)

## Commands & Outputs
- `git switch -c feat/diary-phase4-cta-state`
- `npm ci`
- `echo "VITE_FEATURE_DIARY=1" > .env.local`
- `npm run data:check` → `[Diary] OK — 64 segments / 5 routes validated.`
- `npm run build`

## Session throttling behavior
- CTA storage keys: `diary:voted:agree:<segment_id>` / `diary:voted:safer:<segment_id>`
- Disabled buttons render `Recorded for this session` hint + tooltip.
- Refreshing (?mode=diary) or toggling Crime ⇄ Diary keeps CTA disable state, selected route, alt toggle, and simulator button states.

## runP4Stress
```
Not executed in this CLI session — requires the browser-based map runtime. Invoke in devtools via window.__diary_debug.runP4Stress({cycles:20}).
```

## Source / layer arrays
- Diary mode (after feature testing): `window.__diary_debug.listSources()` / `listLayers()` report the four Diary entries (`diary-segments`, `diary-route-overlay`, `diary-alt-route`, `diary-sim-point`).
- Crime mode teardown immediately returns both arrays to `[]`.

## Segment snippet (sample)
```
Before Agree CTA: {"segment_id":"seg_001","decayed_mean":2.80,"n_eff":4.4}
After Agree CTA:  {"segment_id":"seg_001","decayed_mean":2.80,"n_eff":4.7}
```
