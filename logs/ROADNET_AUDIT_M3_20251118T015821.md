# Road Network Audit - M3 Packet Analysis

**Date:** 2025-11-18T01:58:21Z
**Agent:** Agent-M (Manager Audit Mode)
**Task:** Diagnose why road network doesn't look realistic in running app

---

## Executive Summary

**Current State:** Road network pipeline is implemented and functional, but produces **unrealistic-looking results** in the browser due to:

1. **Tiny Geographic Coverage:** Only 10 hardcoded street segments covering ~4 city blocks in Center City Philadelphia
2. **No Background Network Layer:** Only the 64 rated demo segments are shown, no contextual street grid
3. **Limited Route Realism:** Routes are stitched from available segments but don't represent plausible trips across the city

**Root Cause:** Using fallback `SAMPLE_STREETS` (10 features) instead of real OpenDataPhilly dataset.

**Impact:** Diary demo looks like "noisy short segments" rather than realistic street-based safety ratings.

---

## Pipeline Architecture Analysis

### Intended Design (from docs/ROAD_NETWORK_NOTES.md)

**3-Stage Pipeline:**
1. **Fetch** (fetch_streets_phl.mjs): Download street centerlines from OpenDataPhilly
   - Source: City of Philadelphia Street Centerlines (ArcGIS REST)
   - Env var: `STREETS_PHL_URL` (optional override)
   - Fallback: Baked Center City sample (10 streets)
   - Output: `data/streets_phl.raw.geojson`

2. **Segment** (segment_streets_phl.mjs): Split into ~150m chunks
   - Input: `data/streets_phl.raw.geojson`
   - Process: Filter to study bbox, split with turf.lineChunk, classify by func_class
   - Output: `data/segments_phl.network.geojson`

3. **Generate Demo** (generate_demo_data.mjs): Create rated segments + routes
   - Input: `data/segments_phl.network.geojson` (if exists)
   - Process: Select 64 segments, assign safety ratings, build 5 routes
   - Output: `data/segments_phl.demo.geojson`, `data/routes_phl.demo.geojson`

---

## Actual Data Generated (2025-11-18 Audit)

### Commands Run
```bash
node -e "import('./scripts/fetch_streets_phl.mjs').then(m => m.fetchStreetsPhl())"
node -e "import('./scripts/segment_streets_phl.mjs').then(m => m.segmentStreetsPhl())"
npm run data:gen
npm run data:check
```

### Results

#### 1. Raw Streets (`data/streets_phl.raw.geojson`)
```
✅ 10 features
Bbox: [-75.1936, 39.9421] - [-75.1502, 39.9600]
Sample properties: name, func_class

Streets:
- Market St (func_class: 2)
- Chestnut St (func_class: 3)
- Walnut St (func_class: 3)
- Spruce St (func_class: 4)
- S 33rd St (func_class: 4)
- S 30th St (func_class: 2)
- S 22nd St (func_class: 3)
- Broad St (func_class: 1)
- Pine St (func_class: 4)
- South St (func_class: 3)
```

**Analysis:**
- **Coverage:** ~0.04° longitude × ~0.02° latitude ≈ **4-5 city blocks**
- **Area:** From 30th St Station area to City Hall (west to east)
- **Source:** Hardcoded fallback sample (scripts/fetch_streets_phl.mjs lines 16-70)
- **Reason:** `STREETS_PHL_URL` environment variable not set, placeholder URL fails

#### 2. Network Segments (`data/segments_phl.network.geojson`)
```
✅ 185 features
Bbox: [-75.1936, 39.9421] - [-75.1502, 39.9600]
Class distribution: { '1': 12, '2': 34, '3': 82, '4': 57 }
Length (m): min=16, median=150, max=150
Sample properties: segment_id, street_name, class, length_m
```

**Analysis:**
- **Segmentation:** 10 raw streets → 185 segments (turf.lineChunk with 150m target)
- **Classes:** Properly distributed across 4 functional classes
  - Class 1 (Major arterials): 12 segments (Broad St)
  - Class 2 (Arterials): 34 segments (Market, 30th St)
  - Class 3 (Collectors): 82 segments (Chestnut, Walnut, 22nd St, South St)
  - Class 4 (Local streets): 57 segments (Spruce, Pine, 33rd St)
- **Geometry:** Actual street alignments preserved (LineString coordinates match OSM)
- **Spatial Consistency:** Segments align end-to-end (ready for graph traversal)

#### 3. Demo Segments (`data/segments_phl.demo.geojson`)
```
✅ 64 features
Bbox: [-75.1935, 39.9485] - [-75.1502, 39.9559]
Class distribution: { '2': 24, '3': 40 }
Length (m): min=110, median=150, max=150
Sample properties: segment_id, street, length_m, decayed_mean, n_eff, top_tags, delta_30d, class
```

**Analysis:**
- **Selection:** First 64 segments from network (185 total)
- **Missing Classes:** No class 1 or 4 in demo (only selected from subset)
- **Safety Ratings:** Synthetic decayed_mean (1-5), n_eff, delta_30d, top_tags overlaid
- **Smaller Bbox:** Demo segments cover even smaller area than full network

#### 4. Demo Routes (`data/routes_phl.demo.geojson`)
```
✅ 5 features
Bbox: [-75.1900, 39.9485] - [-75.1515, 39.9523]
Length (m): min=1050, median=1500, max=1500
Segments per route: min=7, max=10
Sample properties: route_id, name, mode, from, to, length_m, duration_min, segment_ids, alt_segment_ids
```

**Analysis:**
- **Route Construction:** Chains of 7-10 connected segments (1-1.5km each)
- **Geometry:** Actual LineString following street network
- **Alternatives:** Each route has `alt_segment_ids` and `alt_geometry` (working as designed)
- **Realism:** Routes are technically valid (segments connect) but cover tiny area

---

## Map Layer Integration Analysis

### Current Implementation

**File:** [src/map/segments_layer.js](../src/map/segments_layer.js)

**Lines 27-46:** `mountSegmentsLayer()`
- Creates two layers from `diary-segments` source:
  - `diary-segments-hit` (invisible, wide hit area for clicks)
  - `diary-segments-line` (visible, colored by `decayed_mean`)
- Line width computed as: `widthForNEff(n_eff) + classWidth(class) - 1.5`
  - Class 1: +3.8px base
  - Class 2: +3.0px base
  - Class 3: +2.2px base
  - Class 4: +1.5px base
- Color based on safety rating (red=unsafe → green=safe)

**File:** [src/routes_diary/index.js](../src/routes_diary/index.js)

**Lines 23-30:** Data loading
```javascript
const SEGMENT_URL_CANDIDATES = [
  '/data/segments_phl.demo.geojson',  // ← Only loads demo (64 segments)
  new URL('../../data/segments_phl.demo.geojson', import.meta.url).href,
];
```

**Lines 1613-1620:** `loadDemoSegments()`
- Fetches `segments_phl.demo.geojson` (64 rated segments)
- Normalizes and caches
- **Does NOT load** full network (185 segments)

### What's Missing

1. **No Background Network Layer**
   - Full `segments_phl.network.geojson` (185 segments) never rendered
   - User sees only 64 rated segments, no street grid context
   - Should have:
     - Background layer: All network segments (light gray, styled by class)
     - Foreground layer: Rated demo segments (colored by safety)

2. **No Layer Toggle**
   - No UI control to show/hide road network layer
   - Could add to Diary panel (similar to alt route toggle)

3. **No Multi-Class Styling Visible**
   - Class-based width is computed but not visually apparent
   - All segments look similar width (dominated by n_eff component)

---

## Root Cause: Why It Looks Unrealistic

### Geographic Coverage

**Problem:** Only 4-5 city blocks shown
```
Current Bbox: [-75.1936, 39.9421] - [-75.1502, 39.9600]
Coverage:      ~0.04° lon × ~0.02° lat ≈ 4-5 blocks

Philly Bbox:  [-75.28, 39.87] - [-75.00, 40.14]
Full City:    ~0.28° lon × ~0.27° lat ≈ 100+ km²
```

**Why:**
- `STREETS_PHL_URL` not set → using fallback sample (10 streets)
- Segmentation bbox filter (line 12): `[-75.25, 39.90, -75.13, 39.97]`
- Even if real data loaded, would only cover Center City (study area)

**Impact:**
- User zooms out → sees tiny cluster of segments
- Routes are 1-1.5km but only within 4 blocks (not plausible "trips")
- No sense of citywide safety patterns

### Visual Clarity

**Problem:** No street grid context

**What User Sees:**
- 64 colored line segments floating on MapLibre basemap
- Segments align with basemap streets (correct) but no visual hierarchy
- Can't distinguish major roads from local streets

**What User Should See:**
- Light gray network layer (all streets, subtle width differences)
- Colored safety overlay (rated segments stand out)
- Clear functional class hierarchy (highways > arterials > collectors > local)

### Route Plausibility

**Problem:** Routes don't represent realistic trips

**Current Routes:**
- Start/end points within same 4-block area
- Example: "30th St to Broad St" (1.5km) is plausible distance
- But both endpoints in tiny sample → looks like arbitrary paths

**What's Needed:**
- Routes spanning realistic trip pairs:
  - "University City → Center City" (3km)
  - "South Philly → Old City" (5km)
  - "North Philly → Temple University" (2km)
- Requires full city network or at least multi-neighborhood coverage

---

## File Locations & Key Code References

### Scripts
- [scripts/fetch_streets_phl.mjs:12-14](../scripts/fetch_streets_phl.mjs#L12-L14) — `STREETS_PHL_URL` definition
- [scripts/fetch_streets_phl.mjs:16-70](../scripts/fetch_streets_phl.mjs#L16-L70) — `SAMPLE_STREETS` fallback (10 features)
- [scripts/segment_streets_phl.mjs:12](../scripts/segment_streets_phl.mjs#L12) — Study bbox filter
- [scripts/segment_streets_phl.mjs:41-44](../scripts/segment_streets_phl.mjs#L41-L44) — Segmentation (turf.lineChunk)
- [scripts/generate_demo_data.mjs:129-147](../scripts/generate_demo_data.mjs#L129-L147) — Network segment consumption

### Data Files (Generated)
- `data/streets_phl.raw.geojson` — 10 features (baked sample)
- `data/segments_phl.network.geojson` — 185 segments (all classes)
- `data/segments_phl.demo.geojson` — 64 segments (rated, class 2-3 only)
- `data/routes_phl.demo.geojson` — 5 routes (7-10 segments each)

### Map Integration
- [src/map/segments_layer.js:27-46](../src/map/segments_layer.js#L27-L46) — Layer mounting
- [src/map/segments_layer.js:107-113](../src/map/segments_layer.js#L107-L113) — `classWidth()` function
- [src/routes_diary/index.js:23-30](../src/routes_diary/index.js#L23-L30) — Demo data URLs
- [src/routes_diary/index.js:1613-1620](../src/routes_diary/index.js#L1613-L1620) — `loadDemoSegments()`

---

## Diagnosis Summary

| Issue | Current State | Why It Happens | Impact |
|-------|--------------|----------------|--------|
| **Geographic coverage** | 4-5 blocks only | Using 10-street sample, no `STREETS_PHL_URL` set | Looks like "tiny cluster", not citywide |
| **No background network** | Only 64 rated segments visible | Code loads `demo.geojson`, not `network.geojson` | No street grid context, hard to orient |
| **Class hierarchy not visible** | Subtle width differences | Width formula dominated by `n_eff`, class is minor component | Can't distinguish major roads from local |
| **Route realism** | 1-1.5km routes within tiny area | Route endpoints both in same 4 blocks | Doesn't look like real trips across city |
| **Missing UI controls** | No road network toggle | Not implemented | Can't toggle contextual street grid on/off |

---

## Data Quality Assessment

### ✅ What's Working

1. **Segmentation Algorithm:** Correctly splits long streets into ~150m chunks
2. **Functional Classification:** Properly maps `func_class` → 1-4 classes
3. **Geometry Preservation:** Segments align with real streets (OSM coordinates)
4. **Route Construction:** Routes are valid connected graphs
5. **Data Validation:** `npm run data:check` passes (referential integrity OK)
6. **Rating Overlay:** Safety metrics (decayed_mean, n_eff, tags) work as designed

### ❌ What's Broken/Missing

1. **Data Source:** Not using real OpenDataPhilly streets (using fallback)
2. **Coverage:** Orders of magnitude too small (4 blocks vs. 100+ km²)
3. **Visualization:** Missing background network layer
4. **Class Styling:** Functional classes not visually distinguishable
5. **UI Controls:** No road network toggle in panel
6. **Route Scope:** Start/end points too close together

---

## Environment Analysis

### STREETS_PHL_URL Status

**Checked Locations:**
- `.env.local` — File exists, contains `VITE_FEATURE_DIARY=1`, **no STREETS_PHL_URL**
- `.env.example` — Does not exist
- `docs/ROAD_NETWORK_NOTES.md` — Documents `STREETS_PHL_URL` but gives no working URL
- `scripts/fetch_streets_phl.mjs` — Default URL is placeholder (will fail)

**Conclusion:** Environment variable not set anywhere → always uses fallback sample.

### Real Data Source Needed

**Target Dataset:** Philadelphia Street Centerlines
- **Provider:** City of Philadelphia / OpenDataPhilly
- **Format:** GeoJSON (EPSG:4326)
- **Expected Fields:** `SEG_ID`, `STNAME`/`name`, `FUNC_CLASS`/`CLASS`, `Shape_Length`, geometry
- **Estimated Size:** ~50,000-100,000 street segments citywide

**Actual URL (as of 2025):** Need to find current ArcGIS REST endpoint or GeoJSON download link.

---

## Inspection Tools Created

**File:** [scripts/inspect_roadnet.mjs](../scripts/inspect_roadnet.mjs)

**Purpose:** Quick diagnostic tool to analyze road network data files

**Usage:**
```bash
node scripts/inspect_roadnet.mjs
```

**Output:** Feature counts, bbox, property samples, class distribution, length stats

**Status:** ✅ Created during this audit, can be reused for future verification

---

## Next Steps (High-Level)

See [docs/ROAD_NETWORK_NOTES.md](../docs/ROAD_NETWORK_NOTES.md) "Implementation Plan" section for detailed breakdown.

**Summary:**

1. **Fix Data Source** (P0 - Critical)
   - Find working OpenDataPhilly Streets endpoint
   - Set `STREETS_PHL_URL` or download static GeoJSON
   - Regenerate with full city coverage

2. **Add Background Network Layer** (P1 - High)
   - Load `segments_phl.network.geojson` as separate source
   - Render with subtle styling (gray, class-based width)
   - Layer below rated segments

3. **Improve Route Generation** (P1 - High)
   - Pick realistic start/end pairs across neighborhoods
   - Use graph traversal (Dijkstra/A*) for plausible paths
   - Ensure routes span 2-5km (typical trip distances)

4. **Add UI Toggle** (P2 - Medium)
   - "Show road network" checkbox in Diary panel
   - Toggle background layer visibility
   - Default: on (provides context)

5. **Enhance Class Styling** (P2 - Medium)
   - Increase class width differences (make hierarchy visible)
   - Consider color tint by class (subtle, not dominant)

---

## Acceptance Criteria for "Realistic Network"

When fixed, the app should show:

- [ ] **Geographic Scope:** Entire Philadelphia or at least multi-neighborhood (5+ km²)
- [ ] **Background Grid:** Light gray street network visible beneath safety ratings
- [ ] **Class Hierarchy:** Visibly wider lines for major roads (class 1) vs. local streets (class 4)
- [ ] **Plausible Routes:** Demo routes span realistic trips (2-5km, different neighborhoods)
- [ ] **Data Quality:** Real OpenDataPhilly streets, not synthetic fallback
- [ ] **UI Control:** Optional toggle to show/hide background network
- [ ] **Validation:** `npm run data:check` still passes with larger dataset

---

**Audit Complete**
**Agent:** Agent-M
**Mode:** Manager-Fixes-Allowed
**Timestamp:** 2025-11-18T01:58:21Z
