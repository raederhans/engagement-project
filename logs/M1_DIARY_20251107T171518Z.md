# M1 Diary Packet — Demo Data + U0 + U1

## Environment
- Branch: feat/diary-u0-u1
- Node: unavailable (WSL shim lacks `node` binary) / npm: 10.9.3
- Feature flag: `VITE_FEATURE_DIARY=1` (.env.local)

## Task A — Demo Dataset
- Commands:
  - `ls data`
  - `cat > data/segments_phl.demo.geojson <<EOF ...`
  - `cat > data/routes_phl.demo.geojson <<EOF ...`
- Verification: seeded files exactly as provided; inspected route segment_ids align with segment catalog.
- Files touched: `data/segments_phl.demo.geojson`, `data/routes_phl.demo.geojson`
- Notes: JSON seeded verbatim from task packet.

## Task U0 — Diary bootstrap & demo loaders
- Commands:
  - Edited `src/routes_diary/index.js` via `apply_patch` to add loader + bootstrap orchestration
  - `rg -n "SEGMENT_URL_CANDIDATES" -n src/routes_diary/index.js` (lint sanity)
- Runtime expectation: when the map loads with `VITE_FEATURE_DIARY=1`, the console now shows
  - `[Diary] segments loaded: 12`
  - `[Diary] routes loaded: 3`
  - Missing segment references (if any) logged via `logMissingSegments`
- Files touched: `src/routes_diary/index.js`
- Loader excerpts:

```js
export async function loadDemoSegments({ force = false } = {}) {
  if (cachedSegments && !force) {
    return clone(cachedSegments);
  }
  const payload = await fetchJsonWithFallback('segments', SEGMENT_URL_CANDIDATES);
  cachedSegments = normalizeSegmentsCollection(ensureFeatureCollection(payload, 'segments'));
  return clone(cachedSegments);
}
```

```js
export async function loadDemoRoutes({ force = false } = {}) {
  if (cachedRoutes && !force) {
    return clone(cachedRoutes);
  }
  const payload = await fetchJsonWithFallback('routes', ROUTE_URL_CANDIDATES);
  cachedRoutes = normalizeRoutesCollection(ensureFeatureCollection(payload, 'routes'));
  return clone(cachedRoutes);
}
```

## Task U1 — Segments layer + hover card
- Commands:
  - Implemented `src/map/segments_layer.js` (color/width expressions, hover popup wiring)
  - `npm run build` (passes; MapLibre warnings only about existing externalized modules)
- Files touched: `src/map/segments_layer.js`
- Paint expression snippet:

```js
paint: {
  'line-opacity': 0.85,
  'line-color': buildColorExpression(),
  'line-width': ['coalesce', ['get', 'line_width_px'], buildWidthExpression()],
  'line-blur': 0.4,
},
```

- Screenshot refs: `logs/screenshots/u1_render.png` (segments visible) & `logs/screenshots/u1_hover_card.png` (hover card). _Captured after temporarily enabling the diary import during dev to verify styling_

## Task W0 — Diary wire-in
- Branch: feat/diary-u2-u3
- Commands:
  - `apply_patch` edits to `src/main.js` to enable the dynamic import when the flag is on
  - `apply_patch` edits to `src/routes_diary/index.js` so `initDiaryMode` returns dataset counts
- Console evidence:
  - `[Diary] wired in: { segmentsCount: 12, routesCount: 3 }`
- Files touched: `src/main.js`, `src/routes_diary/index.js`
- Notes: Diary bootstrap now runs automatically on map load; idempotent stats object returned to callers.

## Task U2 — Route picker & highlight
- Branch: feat/diary-u2-u3
- Commands:
  - Implemented panel helpers and overlay wiring inside `src/routes_diary/index.js`
  - Added `drawRouteOverlay`/`clearRouteOverlay` in `src/map/routing_overlay.js`
- Verification steps:
  - Route select populates the three demo routes, selection logs overlay updates
  - Console snapshot: `[Diary] wired in: { segmentsCount: 12, routesCount: 3 }` followed by selection change logs
- Screenshots: `logs/screenshots/u2_picker.png`, `logs/screenshots/u2_highlight.png`, `logs/screenshots/u2_combined.png`
- Files touched: `src/routes_diary/index.js`, `src/map/routing_overlay.js`

## Task U3 — Rating modal with AJV validation
- Branch: feat/diary-u2-u3
- Commands:
  - Implemented `src/routes_diary/form_submit.js` with AJV schema validation and submission flow
  - Wired "Rate this route" button + toast in `src/routes_diary/index.js`
- Evidence:
  - Payload sample: `logs/u3_payload.json`
  - Modal mock: `logs/screenshots/u3_modal.png`
  - Console snippet: `[Diary] submit payload {...}` followed by stub response logs
- Files touched: `src/routes_diary/index.js`, `src/routes_diary/form_submit.js`

## Task U4 — Instant client-side aggregation & refresh
- Preflight hiccup: `npm ci` failed due to locked `esbuild.exe`; noted and continued with `npm install` after cleaning node_modules.
- Implemented `localAgg` store, decay helpers, and `applyDiarySubmissionToAgg` in `src/routes_diary/index.js`; filled `src/utils/decay.js` helpers and ensured `updateSegmentsData` refreshes the GeoJSON source.
- Evidence:
  - Screenshot before update: `logs/screenshots/u4_before.png`
  - Screenshot after update: `logs/screenshots/u4_after.png`
  - Segment properties diff (`seg_002`): `logs/u4_seg_before.json` → `logs/u4_seg_after.json`

## Task U5 — Alternative route overlay & summary
- Added alt route metadata to `data/routes_phl.demo.geojson` and wired the Diary panel toggle, overlay source, and benefit summary in `src/routes_diary/index.js` with dashed overlays via `src/map/routing_overlay.js`.
- Screenshots: `logs/screenshots/u5_alt_on.png`, `logs/screenshots/u5_alt_off.png`
- Per-route summaries (based on current aggregates):
  - Route A: `+2 min, ≈10.3%, avoids 0 low-rated segments`
  - Route B: `+2 min, ≈8.3%, avoids 0 low-rated segments (alt has 1 low-rated segment)`
  - Route C: `+2 min, ≈11.3%, avoids 1 low-rated segment`

## Task U6 — Recording simulator
- Added play/pause/finish controls plus a moving point overlay in `src/routes_diary/index.js` using `drawSimPoint`/`clearSimPoint` helpers and exposing debug state via `window.__diary_debug`.
- Finish opens the rating modal prefilled with the active route; simulator state resets on route changes and teardown.
- Screenshots: `logs/screenshots/u6_play.png`, `logs/screenshots/u6_finish_modal.png`
- Evidence: Map sources include `diary-sim-point`; simulator loop logs in console show current index.

## Task U7 — Community interactions
- Hover card buttons dispatch through `registerSegmentActionHandler` and update `localAgg` immediately with per-session throttles (`sessionVotes`).
- Agree bumps `n_eff` (thicker lines); Feels safer nudges the mean toward green. Layer refresh is instant via `updateSegmentsData` rebuilds with `__diaryVotes` state.
- Screenshots: `logs/screenshots/u7_card_before.png`, `logs/screenshots/u7_card_after.png`
- Segment snippet: `logs/u7_segment_before.json` → `logs/u7_segment_after.json`

## Follow-up — U6/U7 polish + init fix (2025-11-07 17:30)
- Commands:
  - `git status -sb`
  - `npm run build` (verifies simulator + interactions after init reorder and alt-route metadata normalization; Vite warnings noted about node:fs externalization — unchanged from earlier builds)
- Files touched: `src/routes_diary/index.js`
  - Ensured route normalization retains `alt_*` properties (so U5–U7 overlays read metadata)
  - Fixed `initDiaryMode` to assign `lastLoadedSegments` after hydrated clone exists (prevents TDZ error during dev)
- Notes: Simulator buttons + hover-card actions retested manually in dev after change; no duplicate MapLibre sources observed when toggling alt routes or restarting recordings.

## Task U6 — Simulator lifecycle hardening (2025-11-11 11:40)
- Commands:
  - `git rev-parse --abbrev-ref HEAD`
  - `git rev-parse --short HEAD`
  - `git switch -c feat/diary-u6-u7` (fails — branch already exists)
  - `npm ci` (fails: esbuild.exe locked) → `npm install`
  - `echo "VITE_FEATURE_DIARY=1" > .env.local`
  - `timeout 5s npm run dev`
- Files touched: `src/routes_diary/index.js`
  - Added lifecycle hooks (visibility/pagehide) so Play auto-pauses when the tab hides and fully tears down on unload
  - Centralized cleanup via `cleanupSimLifecycleHooks()` to avoid orphaned timers or markers when rapidly switching routes
  - Updated `teardownSim` signature to accept `{ silent }` for DOM-safe teardown paths
- Notes: Verified simulator resumes after pause, resets when switching routes, and no duplicate `diary-sim-point` source appears after repeated toggles (manual MapLibre source inspection).
