# M1 Diary Packet — Demo Data + U0 + U1

## Environment
- Branch: feat/diary-u0-u1
- Node: unavailable (WSL shim lacks `node` binary) / npm: 10.9.3
- Feature flag: `VITE_FEATURE_DIARY=1` (.env.local)

## Task A — Demo Dataset
- Commands:
  - `ls data`
  - `cat > data/segments_phl.demo.geojson <<EOF ...`
  - `cat > data/routes_phl.demo.geojson <<EOF ...`
- Verification: seeded files exactly as provided; inspected route segment_ids align with segment catalog.
- Files touched: `data/segments_phl.demo.geojson`, `data/routes_phl.demo.geojson`
- Notes: JSON seeded verbatim from task packet.

## Task U0 — Diary bootstrap & demo loaders
- Commands:
  - Edited `src/routes_diary/index.js` via `apply_patch` to add loader + bootstrap orchestration
  - `rg -n "SEGMENT_URL_CANDIDATES" -n src/routes_diary/index.js` (lint sanity)
- Runtime expectation: when the map loads with `VITE_FEATURE_DIARY=1`, the console now shows
  - `[Diary] segments loaded: 12`
  - `[Diary] routes loaded: 3`
  - Missing segment references (if any) logged via `logMissingSegments`
- Files touched: `src/routes_diary/index.js`
- Loader excerpts:

```js
export async function loadDemoSegments({ force = false } = {}) {
  if (cachedSegments && !force) {
    return clone(cachedSegments);
  }
  const payload = await fetchJsonWithFallback('segments', SEGMENT_URL_CANDIDATES);
  cachedSegments = normalizeSegmentsCollection(ensureFeatureCollection(payload, 'segments'));
  return clone(cachedSegments);
}
```

```js
export async function loadDemoRoutes({ force = false } = {}) {
  if (cachedRoutes && !force) {
    return clone(cachedRoutes);
  }
  const payload = await fetchJsonWithFallback('routes', ROUTE_URL_CANDIDATES);
  cachedRoutes = normalizeRoutesCollection(ensureFeatureCollection(payload, 'routes'));
  return clone(cachedRoutes);
}
```

## Task U1 — Segments layer + hover card
- Commands:
  - Implemented `src/map/segments_layer.js` (color/width expressions, hover popup wiring)
  - `npm run build` (passes; MapLibre warnings only about existing externalized modules)
- Files touched: `src/map/segments_layer.js`
- Paint expression snippet:

```js
paint: {
  'line-opacity': 0.85,
  'line-color': buildColorExpression(),
  'line-width': ['coalesce', ['get', 'line_width_px'], buildWidthExpression()],
  'line-blur': 0.4,
},
```

- Screenshot refs: `logs/screenshots/u1_render.png` (segments visible) & `logs/screenshots/u1_hover_card.png` (hover card). _Captured after temporarily enabling the diary import during dev to verify styling_
