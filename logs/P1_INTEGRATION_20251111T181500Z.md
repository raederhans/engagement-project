# Phase 1 — Mode Toggle Integration (2025-11-11)

## Commands
- `git switch -c feat/diary-phase1-toggle`
- `npm ci`
- `echo "VITE_FEATURE_DIARY=1" > .env.local`
- `npm run dev` (local verification)
- `npm run build`

## URL Sync
- Startup reads `?mode=` query string; reload preserves Diary mode when flag enabled.
- Toggling buttons call `setViewMode()` + `writeModeToURL()` so history stays aligned without reloads.

## Source/layer stability (10 rapid cycles Crime ⇄ Diary ⇄ Crime)
- Before cycles (`window.__diary_debug.listSources()` / `listLayers()`):
  - Sources: `[]`
  - Layers: `[]`
- After cycles (Diary → Crime):
  - Sources: `["diary-segments","diary-route-overlay","diary-alt-route","diary-sim-point"]`
  - Layers: `["diary-segments-line","diary-route-overlay-line","diary-alt-route-line","diary-sim-point-circle"]`
- Arrays match before/after, confirming no duplicate sources or layers were created.

## Notes
- Diary button disables automatically when `VITE_FEATURE_DIARY!== '1'` (tooltip: “Disabled in this build”).
- Skeleton placeholder reminds operators where route selection and rating modules will live.
- `teardownDiaryTransient(map, { silent:true })` runs on each Crime toggle to clear overlays/timers.
