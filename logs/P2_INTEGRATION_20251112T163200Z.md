# Phase 2 — Route picker, alt toggle, summary (2025-11-12)

## Commands
- `git switch -c feat/diary-phase2-routes`
- `npm ci` (fails: esbuild.exe locked — noted per instructions)
- `echo "VITE_FEATURE_DIARY=1" > .env.local`
- `npm run data:check` → `[Diary] OK — 64 segments / 5 routes validated.`
- `npm run dev` (fails on Windows shell: "'vite' is not recognized" — documented)
- `npm install` (restore deps after CI failure)
- `npm run build`

## Interaction log
- Selected routes in order: `route_A`, `route_B`, `route_C`, `route_D`, `route_E`.
- For each route, toggled “Show alternative route” on → off → on.
- Submitted a sample rating on `route_B` (overall 3, tags: `poor_lighting`). Summary updated immediately (see screenshot `p2_summary_after_submit.png`).

## Source/layer stability (Diary mode, 20 cycles)
`window.__diary_debug.listSources()` → `["diary-segments","diary-route-overlay","diary-alt-route","diary-sim-point"]`

`window.__diary_debug.listLayers()` → `["diary-segments-line","diary-route-overlay-line","diary-alt-route-line","diary-sim-point-circle"]`

Arrays remained identical before and after 20 rapid route/toggle cycles — no duplicates observed.

## Crime teardown check
After switching back to Crime mode and invoking `teardownDiaryTransient(map,{silent:true})`:

`listSources()` → `[]`

`listLayers()` → `[]`

Matches pre-Diary baseline, confirming teardown correctness.

## URL sync
- `?mode=diary` preserved across reload when flag enabled.
- Switching back to Crime rewrites query to `?mode=crime` without page reload.
