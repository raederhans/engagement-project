<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Renter-Oriented Crime Dashboard</title>
    <link href="https://unpkg.com/maplibre-gl@^4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      html, body { height: 100%; margin: 0; }
      #map { position: absolute; inset: 0; }
      #legend {
        position: fixed; bottom: 12px; right: 12px; z-index: 1010;
        background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 8px;
        font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        max-width: 200px;
      }
      @media (max-width: 768px) {
        #legend { bottom: 72px; }
      }
      #legend .swatch { display: inline-block; width: 14px; height: 14px; margin-right: 6px; vertical-align: middle; }
      #legend .row { white-space: nowrap; }
      #tooltip {
        position: fixed; pointer-events: none; z-index: 20; display: none;
        background: rgba(0,0,0,0.8); color: #fff; padding: 6px 8px; border-radius: 4px; font-size: 12px;
        transform: translate(8px, -8px);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="legend"></div>
    <div id="tooltip"></div>
    <div id="sidepanel" style="position:fixed; left:12px; top:12px; z-index:18; width:300px; max-height:88vh; overflow:auto; background:rgba(255,255,255,0.97); padding:12px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.15)">
      <div style="font:600 14px/1.2 system-ui, sans-serif; margin-bottom:8px;">Controls</div>

      <label for="queryModeSel" style="display:block; font-size:12px; color:#374151;">Query Mode</label>
      <select id="queryModeSel" style="width:100%; margin-bottom:4px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
        <option value="buffer" selected>Buffer</option>
        <option value="district">Police District</option>
        <option value="tract">Census Tract</option>
      </select>
      <div id="queryModeHelp" style="color:#64748b; font-size:12px; margin-bottom:8px;">Buffer mode: click “Select on map”, then click map to set center.</div>
      <button id="clearSelBtn" style="display:none; margin-bottom:8px; padding:6px 8px; border:1px solid #94a3b8; background:#f8fafc; border-radius:6px; cursor:pointer;">Clear selection</button>
      <div id="bufferSelectRow">
        <label for="addrA" style="display:block; font-size:12px; color:#374151;">Address A</label>
        <div style="display:flex; gap:6px; margin-bottom:8px;">
          <input id="addrA" type="text" placeholder="Enter address (placeholder)" style="flex:1; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;" />
          <button id="useCenterBtn" style="padding:6px 8px; border:1px solid #94a3b8; background:#f8fafc; border-radius:6px; cursor:pointer;">Select on map</button>
        </div>
        <div id="useMapHint" style="display:none; color:#64748b; font-size:12px; margin-top:-4px; margin-bottom:8px;">Click the map to set A (center). Press Esc to cancel.</div>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:8px;">
        <div id="bufferRadiusRow" style="flex:1;">
          <label for="radiusSel" style="display:block; font-size:12px; color:#374151;">Radius</label>
          <select id="radiusSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
            <option value="400">400 m</option>
            <option value="800">800 m</option>
          </select>
        </div>
        <div style="flex:1;">
          <label for="twSel" style="display:block; font-size:12px; color:#374151;">Time Window</label>
          <select id="twSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
            <option value="3">3 months</option>
            <option value="6" selected>6 months</option>
            <option value="12">12 months</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:8px;">
        <div style="flex:1;">
          <label for="adminSel" style="display:block; font-size:12px; color:#374151;">Admin Level</label>
          <select id="adminSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
            <option value="districts" selected>Districts</option>
            <option value="tracts">Tracts</option>
          </select>
        </div>
        <div style="flex:1;">
          <label for="rateSel" style="display:block; font-size:12px; color:#374151;">Rate</label>
          <select id="rateSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
            <option value="counts" selected>Counts</option>
            <option value="per10k">per-10k</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:8px;">
        <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#374151; cursor:pointer;">
          <input type="checkbox" id="overlayTractsChk" style="width:14px; height:14px;">
          <span>Show tracts overlay</span>
        </label>
      </div>

      <label for="groupSel" style="display:block; font-size:12px; color:#374151;">Offense Groups</label>
      <select id="groupSel" multiple size="6" style="width:100%; margin-bottom:8px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
        <option value="property">Property</option>
        <option value="vehicle">Vehicle</option>
        <option value="burglary">Burglary</option>
        <option value="robbery_gun">Robbery (gun)</option>
        <option value="assault_gun">Assault (gun)</option>
        <option value="vandalism_other">Vandalism/Other</option>
      </select>

      <label for="fineSel" style="display:block; font-size:12px; color:#374151;">Drilldown</label>
      <select id="fineSel" multiple size="6" style="width:100%; margin-bottom:8px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;"></select>

      <label for="startMonth" style="display:block; font-size:12px; color:#374151;">Start month</label>
      <input id="startMonth" type="month" style="width:100%; margin-bottom:8px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;" />
      <label for="durationSel" style="display:block; font-size:12px; color:#374151;">Duration</label>
      <select id="durationSel" style="width:100%; margin-bottom:8px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
        <option value="3">3 months</option>
        <option value="6" selected>6 months</option>
        <option value="12">12 months</option>
        <option value="24">24 months</option>
      </select>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="preset6" style="flex:1; padding:6px 8px; border:1px solid #94a3b8; background:#f1f5f9; border-radius:6px; cursor:pointer;">Last 6m</button>
        <button id="preset12" style="flex:1; padding:6px 8px; border:1px solid #94a3b8; background:#f1f5f9; border-radius:6px; cursor:pointer;">Last 12m</button>
      </div>

      <details id="help-card" style="margin-top:8px;">
        <summary>Help</summary>
        <ul style="padding-left:18px; font-size:12px; color:#374151;">
          <li>Pick a location (Select on map) and radius for buffer A.</li>
          <li>Time window uses start month + duration.</li>
          <li>Offense groups & drilldown control which codes are included.</li>
          <li>Districts vs Tracts affects choropleth; rate toggle uses ACS for per-10k.</li>
          <li>Clusters aggregate dense points; zoom in to see incidents.</li>
          <li>See README for data sources & disclaimers.</li>
        </ul>
      </details>

      <div id="choropleth-controls" style="margin-top:10px; padding-top:8px; border-top:1px solid #e5e7eb;">
        <div style="font:600 13px/1.2 system-ui, sans-serif; margin:4px 0 8px;">Choropleth</div>
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <div style="flex:1;">
            <label for="classMethodSel" style="display:block; font-size:12px; color:#374151;">Method</label>
            <select id="classMethodSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
              <option value="quantile" selected>Quantile</option>
              <option value="equal">Equal Interval</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="classBinsRange" style="display:block; font-size:12px; color:#374151;">Bins (<span id="classBinsVal">5</span>)</label>
            <input id="classBinsRange" type="range" min="3" max="9" step="1" value="5" style="width:100%;" />
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <div style="flex:1;">
            <label for="classPaletteSel" style="display:block; font-size:12px; color:#374151;">Palette</label>
            <select id="classPaletteSel" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
              <option>Blues</option>
              <option>YlGnBu</option>
              <option>OrRd</option>
              <option>PuBuGn</option>
              <option>Greens</option>
              <option>Purples</option>
              <option>BuGn</option>
              <option>BuPu</option>
              <option>GnBu</option>
              <option>YlOrRd</option>
              <option>RdBu</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="classOpacityRange" style="display:block; font-size:12px; color:#374151;">Opacity (<span id="classOpacityVal">0.75</span>)</label>
            <input id="classOpacityRange" type="range" min="0.2" max="1" step="0.05" value="0.75" style="width:100%;" />
          </div>
        </div>
        <div id="classCustomRow" style="display:none;">
          <label for="classCustomInput" style="display:block; font-size:12px; color:#374151;">Custom breaks (comma-separated)</label>
          <input id="classCustomInput" type="text" placeholder="10,25,50,100" style="width:100%; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;" />
        </div>
      </div>
    </div>
    <div id="compare-card" style="position:fixed; left:12px; bottom:12px; z-index:18; width:300px; background:rgba(255,255,255,0.97); padding:10px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.15)">
      <div style="font:600 13px/1.2 system-ui, sans-serif; margin-bottom:6px;">Compare (A vs B)</div>
      <div style="font:12px/1.4 system-ui, sans-serif; color:#475569;">Waiting for data…</div>
    </div>
    <div id="charts" style="position:fixed; right:12px; top:12px; z-index:15; width:420px; max-height:80vh; overflow:auto; background:rgba(255,255,255,0.95); padding:10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.15)">
      <div style="font:600 13px/1.2 system-ui, sans-serif; margin:4px 0 8px;">Charts</div>
      <div style="margin-bottom:10px">
        <canvas id="chart-monthly" height="140"></canvas>
      </div>
      <div style="margin-bottom:10px">
        <canvas id="chart-topn" height="160"></canvas>
      </div>
      <div>
        <canvas id="chart-7x24" height="180"></canvas>
      </div>
    </div>
    <script type="module" src="/src/main.js"></script>
  </body>
  </html>
